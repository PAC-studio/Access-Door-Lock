<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Entry Door Lock Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root { 
            --bg-color: #f8f9fa; --card-bg: #ffffff; --text-main: #212529; --border-color: #dee2e6; 
            --input-bg: #ffffff; --nav-bg: #ffffff;
        }
        /* ปรับ Dark Mode ตามคำขอ: ตัวอักษรไม่ดำ ตาราง/ช่องไม่ขาว */
        body.dark-mode { 
            --bg-color: #1a1a1a; --card-bg: #2d2d2d; --text-main: #e0e0e0; --border-color: #444444; 
            --input-bg: #3d3d3d; --nav-bg: #2d2d2d;
        }
        
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Kanit', sans-serif; transition: 0.3s; overflow-x: hidden; }
        .card { background-color: var(--card-bg); border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: var(--text-main); }
        .form-control, .form-select { background-color: var(--input-bg) !important; color: var(--text-main) !important; border-color: var(--border-color) !important; }
        .table { color: var(--text-main) !important; }
        .table-light { --bs-table-bg: var(--card-bg); color: var(--text-main); }

        /* Hamburger Sidebar */
        #sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100%; background: var(--nav-bg); z-index: 1050; transition: 0.3s; box-shadow: 4px 0 10px rgba(0,0,0,0.2); overflow-y: auto; }
        #sidebar.active { left: 0; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040; display: none; }
        .sidebar-overlay.active { display: block; }
        
        .hamburger-icon { font-size: 2rem; cursor: pointer; color: var(--text-main); }
        .profile-circle { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; margin: 0 auto; background-size: cover; background-position: center; border: 3px solid #0d6efd; }
        
        #loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white; }
        
        #login-section { height: 100vh; display: flex; align-items: center; justify-content: center; }
        #main-dashboard { display: none; }
        
        .stat-card { background: linear-gradient(45deg, #0d6efd, #003d99); color: white; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; background-size: cover; }
    </style>
</head>
<body>

<div id="loader-overlay">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
    <h5 id="loader-status">กำลังสื่อสารกับบอร์ด...</h5>
</div>

<div class="sidebar-overlay" id="overlay"></div>
<div id="sidebar" class="p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0">เมนูหลัก</h4>
        <i class="bi bi-x-lg hamburger-icon" style="font-size: 1.5rem;" onclick="toggleSidebar()"></i>
    </div>

    <div class="text-center mb-4 border-bottom pb-4">
        <div id="menu-avatar" class="profile-circle mb-2">?</div>
        <h5 id="menu-username" class="fw-bold mb-1">---</h5>
        <button class="btn btn-sm btn-primary rounded-pill px-3" onclick="showModal('profileEditModal')">แก้ไขโปรไฟล์</button>
    </div>

    <div class="list-group list-group-flush">
        <button class="list-group-item list-group-item-action bg-transparent text-main" onclick="showModal('deviceEditModal')"><i class="bi bi-key-fill me-2"></i>แก้ไขรหัสผ่านเข้า-ออก</button>
        <button class="list-group-item list-group-item-action bg-transparent text-main" onclick="showModal('userListModal')"><i class="bi bi-people-fill me-2"></i>รายชื่อผู้ใช้งานทั้งหมด</button>
        <button class="list-group-item list-group-item-action bg-transparent text-main" onclick="showModal('dashboardSettingsModal')"><i class="bi bi-gear-fill me-2"></i>ตั้งค่า Dashboard</button>
        <button class="list-group-item list-group-item-action bg-transparent text-danger mt-4" id="logout-btn-side"><i class="bi bi-box-arrow-right me-2"></i>ออกจากระบบ</button>
    </div>
</div>

<div class="modal fade" id="profileEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">แก้ไขโปรไฟล์และการเข้าสู่ระบบ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div id="edit-avatar-preview" class="profile-circle mb-2">?</div>
                    <input type="file" id="profile-upload" hidden accept="image/*">
                    <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('profile-upload').click()">เปลี่ยนรูปโปรไฟล์</button>
                </div>
                <label class="small fw-bold">ชื่อผู้ใช้ (Login)</label>
                <input type="text" id="edit-login-username" class="form-control mb-3" readonly>
                <label class="small fw-bold">รหัสผ่านใหม่</label>
                <input type="password" id="edit-login-password" class="form-control mb-3" placeholder="ปล่อยว่างหากไม่ต้องการเปลี่ยน">
                <button class="btn btn-primary w-100 fw-bold" onclick="updateLoginProfile()">บันทึกข้อมูลและออกจากระบบ</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deviceEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">แก้ไขรหัสสำหรับใช้เป็นรหัสผ่านเข้า-ออก</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="card p-3 mb-3 border">
                    <h6 class="fw-bold"><i class="bi bi-grid-3x3-gap-fill me-2"></i>Keypad Module</h6>
                    <div class="input-group">
                        <input type="text" id="keypad-input" class="form-control" maxlength="6" value="000000">
                        <button class="btn btn-success" onclick="saveKeypad()">บันทึกรหัส 6 หลัก</button>
                    </div>
                </div>
                <div class="card p-3 mb-3 border">
                    <h6 class="fw-bold"><i class="bi bi-fingerprint me-2"></i>Fingerprint Module</h6>
                    <div class="row g-2">
                        <div class="col-8">
                            <input type="number" id="finger-id-input" class="form-control" placeholder="ระบุ ID เช่น 01">
                        </div>
                        <div class="col-4">
                            <button class="btn btn-warning w-100 text-white fw-bold" onclick="startFingerScan()">เริ่มการแสกน</button>
                        </div>
                    </div>
                </div>
                <div class="card p-3 border">
                    <h6 class="fw-bold"><i class="bi bi-card-heading me-2"></i>RFID Module</h6>
                    <div id="rfid-display" class="mb-2 fw-bold text-primary">รหัสปัจจุบัน: <span id="current-rfid">ยังไม่มีข้อมูล</span></div>
                    <button id="rfid-btn" class="btn btn-info w-100 text-white fw-bold" onclick="startRFIDScan()">เริ่มการแสกนบัตร</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="login-section">
    <div class="card p-4 shadow text-center" style="width: 350px;">
        <h3 class="fw-bold mb-1"><i class="bi bi-shield-lock-fill me-2"></i>Login</h3>
        <p class="small opacity-75 mb-4">Access Entry Door Lock Dashboard</p>
        <input type="text" id="username" class="form-control mb-3 py-2" placeholder="ชื่อผู้ใช้">
        <input type="password" id="password" class="form-control mb-3 py-2" placeholder="รหัสผ่าน">
        <button id="login-btn" class="btn btn-primary w-100 py-2 fw-bold">เข้าสู่ระบบ</button>
        <p id="error-msg" class="text-danger mt-3 small"></p>
    </div>
</div>

<div id="main-dashboard">
    <div class="container py-4">
        <div class="d-flex align-items-center mb-4">
            <i class="bi bi-list hamburger-icon me-3" onclick="toggleSidebar()"></i>
            <h1 class="h2 fw-bold text-primary mb-0">Access Entry Door Lock Dashboard</h1>
        </div>
        
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card p-4 h-100 border-bottom border-secondary border-3">
                    <h6 class="card-label">แสกนครั้งล่าสุด</h6>
                    <h2 id="last-user-text" class="fw-bold my-2"><span id="last-user">---</span></h2>
                    <div id="last-detail-box" class="info-detail mt-2">
                        <span id="last-time">---</span>
                        <span id="last-status-badge" class="badge ms-2">---</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-4 h-100 stat-card shadow-lg">
                    <h6 class="card-label text-white opacity-75">จำนวนคนในห้อง</h6>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-people-fill me-3" style="font-size: 2.5rem;"></i>
                        <div><span id="people-count" class="display-5 fw-bold">0</span><span class="fs-4">คน</span></div>
                    </div>
                    <div id="names-list" class="mt-2"></div>
                </div>
            </div>
        </div>

        <div class="card p-4 shadow-sm history-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0"><i class="bi bi-clock-history me-2"></i>ประวัติการเข้า-ออก</h5>
                <button id="clear-btn" class="btn btn-sm btn-outline-danger px-3">ล้างประวัติ</button>
            </div>
            <div class="table-responsive">
                <table class="table align-middle text-center">
                    <thead><tr><th>วันที่</th><th>เวลา</th><th>ชื่อผู้ใช้</th><th>อุปกรณ์</th><th>สถานะ</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="userListModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">รายชื่อผู้ใช้งานทั้งหมด</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="user-selection-list" class="list-group list-group-flush"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, remove, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCZ0MK0LRsZLpzAclPxflIa7eWAXAdRchM", 
        databaseURL: "https://smart-access-door-lock-default-rtdb.asia-southeast1.firebasedatabase.app" 
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUid = "";
    let userProfiles = {};

    // --- Sidebar Control ---
    window.toggleSidebar = () => {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
    };
    document.getElementById('overlay').onclick = toggleSidebar;

    window.showModal = (id) => {
        toggleSidebar();
        new bootstrap.Modal(document.getElementById(id)).show();
    };

    // --- Theme Mode (Auto 06:00-18:00) ---
    function autoTheme() {
        const hour = new Date().getHours();
        const isDark = hour < 6 || hour >= 18;
        if (isDark) document.body.classList.add('dark-mode');
        else document.body.classList.remove('dark-mode');
    }
    autoTheme();
    setInterval(autoTheme, 60000);

    // --- Auth & Profile ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUid = user.uid;
            const uName = user.email.split('@')[0];
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            document.getElementById('edit-login-username').value = uName;
            
            onValue(ref(db, 'profiles'), (snap) => {
                userProfiles = snap.val() || {};
                updateUIProfile(uName);
            });
            runApp();
        } else {
            document.getElementById('login-section').style.display = 'flex';
            document.getElementById('main-dashboard').style.display = 'none';
        }
    });

    function updateUIProfile(uName) {
        const myProfile = userProfiles[currentUid] || {};
        const avatarBox = document.getElementById('menu-avatar');
        const previewBox = document.getElementById('edit-avatar-preview');
        const nameLabel = document.getElementById('menu-username');
        
        nameLabel.innerText = uName;
        const color = getColorFromName(uName);
        
        if (myProfile.photo) {
            [avatarBox, previewBox].forEach(el => {
                el.style.backgroundImage = `url(${myProfile.photo})`;
                el.innerText = "";
            });
        } else {
            [avatarBox, previewBox].forEach(el => {
                el.style.backgroundImage = "none";
                el.style.backgroundColor = color;
                el.innerText = uName.charAt(0).toUpperCase();
            });
        }
    }

    // --- แก้ไข Profile & Password ---
    window.updateLoginProfile = async () => {
        const newPass = document.getElementById('edit-login-password').value;
        const user = auth.currentUser;

        if (newPass.length > 0) {
            if (newPass.length < 6) return alert("รหัสผ่านต้องมีอย่างน้อย 6 ตัว");
            try {
                await updatePassword(user, newPass);
                alert("เปลี่ยนรหัสผ่านสำเร็จ กรุณาเข้าสู่ระบบใหม่");
                signOut(auth);
            } catch (e) { alert("เกิดข้อผิดพลาด: " + e.message); }
        } else {
            alert("บันทึกข้อมูลเรียบร้อย");
        }
    };

    document.getElementById('profile-upload').onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            update(ref(db, `profiles/${currentUid}`), { photo: reader.result });
        };
        reader.readAsDataURL(file);
    };

    // --- Device Control (Keypad, Finger, RFID) ---
    window.saveKeypad = () => {
        const val = document.getElementById('keypad-input').value;
        set(ref(db, 'device/keypad'), val).then(() => alert("บันทึกรหัส Keypad สำเร็จ"));
    };

    window.startFingerScan = () => {
        const id = document.getElementById('finger-id-input').value;
        if (!id) return alert("กรุณาระบุ ID");
        
        // เช็คว่า ID เคยมีหรือยัง
        onValue(ref(db, `device/fingers/${id}`), (snap) => {
            if (snap.exists()) {
                if (!confirm("ID นี้มีในระบบแล้ว ต้องการเขียนทับหรือไม่?")) return;
            }
            sendBoardCmd("enroll_finger", id);
        }, { onlyOnce: true });
    };

    window.startRFIDScan = () => {
        sendBoardCmd("enroll_rfid", "0");
    };

    function sendBoardCmd(action, val) {
        const loader = document.getElementById('loader-overlay');
        const status = document.getElementById('loader-status');
        loader.style.display = 'flex';
        status.innerText = "กรุณาวางลายนิ้วมือ/ทาบบัตร...";

        set(ref(db, 'board_cmd'), { action: action, value: val, status: "pending", timestamp: Date.now() });

        const cmdRef = ref(db, 'board_cmd');
        onValue(cmdRef, (snap) => {
            const data = snap.val();
            if (data.status === "step2") {
                status.innerText = "กรุณาวางลายนิ้วมืออีกครั้งเพื่อยืนยัน...";
            } else if (data.status === "success") {
                loader.style.display = 'none';
                alert("ดำเนินการสำเร็จ!");
                set(ref(db, 'board_cmd'), null);
            } else if (data.status === "failed") {
                loader.style.display = 'none';
                alert("การแสกนล้มเหลว กรุณาลองใหม่");
                set(ref(db, 'board_cmd'), null);
            }
        });
    }

    // --- Main Logic (Logs & Tables) ---
    function runApp() {
        onValue(ref(db, 'access_logs'), (snapshot) => {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            let peopleIn = [];
            snapshot.forEach((child) => {
                const d = child.val();
                const badgeClass = d.status == 'In' ? 'bg-success' : 'bg-danger';
                tableBody.insertAdjacentHTML('afterbegin', `<tr><td>${d.date}</td><td>${d.timestamp}</td><td class="fw-bold">${d.name}</td><td><small>${d.type}</small></td><td><span class="badge ${badgeClass}">${d.status}</span></td></tr>`);
                
                document.getElementById('last-user').innerText = d.name;
                document.getElementById('last-time').innerText = d.date + " | " + d.timestamp;
                const statusBadge = document.getElementById('last-status-badge');
                statusBadge.innerText = d.status;
                statusBadge.className = `badge ms-2 ${badgeClass}`;

                if(d.status == "In") { if(!peopleIn.includes(d.name)) peopleIn.push(d.name); } 
                else { peopleIn = peopleIn.filter(p => p !== d.name); }
            });
            document.getElementById('people-count').innerText = peopleIn.length;
            renderPeopleInRoom(peopleIn);
        });
        
        // รายชื่อผู้ใช้ทั้งหมด (รวมคนที่ไม่เคยเข้า)
        onValue(ref(db, 'users_list'), (snap) => {
            const listDiv = document.getElementById('user-selection-list');
            listDiv.innerHTML = "";
            snap.forEach(child => {
                const u = child.val();
                listDiv.innerHTML += `<button class="list-group-item list-group-item-action py-3 fw-bold">${u.name}</button>`;
            });
        });
    }

    function renderPeopleInRoom(list) {
        const container = document.getElementById('names-list');
        container.innerHTML = `<div class="d-flex flex-wrap gap-2 mt-2">` + 
            list.map(name => {
                const profile = Object.values(userProfiles).find(p => p.name === name) || {};
                const bg = profile.photo ? `background-image:url(${profile.photo})` : `background-color:${getColorFromName(name)}`;
                const initial = profile.photo ? "" : name.charAt(0).toUpperCase();
                return `<div class="d-flex align-items-center bg-white bg-opacity-10 rounded-pill pe-3" style="border: 1px solid rgba(255,255,255,0.2);">
                    <div class="user-avatar me-2" style="${bg}">${initial}</div>
                    <span class="text-white small">${name}</span>
                </div>`;
            }).join('') + `</div>`;
    }

    function getColorFromName(name) {
        const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#009688', '#4caf50', '#ff9800', '#795548'];
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        return colors[Math.abs(hash) % colors.length];
    }

    document.getElementById('login-btn').onclick = () => {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        signInWithEmailAndPassword(auth, u + "@insight.com", p).catch(() => alert("รหัสผ่านผิด"));
    };
    
    document.getElementById('logout-btn-side').onclick = () => signOut(auth);
</script>
</body>
</html>
