<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root { --bg-color: #f8f9fa; --card-bg: #ffffff; --text-main: #212529; --border-color: #dee2e6; --accent: #0d6efd; }
        
        body.dark-mode { 
            --bg-color: #0f172a; 
            --card-bg: #1e293b; 
            --text-main: #f1f5f9; 
            --border-color: #334155; 
        }

        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Kanit', sans-serif; transition: 0.3s; overflow-x: hidden; }
        
        #sidebar { position: fixed; right: -280px; left: auto; top: 0; width: 280px; height: 100%; background: var(--card-bg); z-index: 1050; transition: 0.3s; border-left: 1px solid var(--border-color); border-right: none; padding: 20px; }
        #sidebar.active { right: 0; left: auto; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1040; }
        .sidebar-overlay.active { display: block; }
        
        .menu-item { padding: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; transition: 0.2s; color: var(--text-main); font-weight: 500; }
        .menu-item:hover { background: var(--accent); color: #ffffff !important; }
        .menu-item.danger-item:hover { background: #dc3545; color: #ffffff !important; }

        .dark-mode .table { color: #f1f5f9 !important; background-color: transparent !important; border-color: #334155 !important; }
        .dark-mode .table thead th { background-color: #334155 !important; color: #60a5fa !important; border-bottom: 2px solid #475569 !important; }
        .dark-mode .table tbody td { background-color: #1e293b !important; color: #f1f5f9 !important; border-bottom: 1px solid #334155 !important; }
        .dark-mode .modal-content { background-color: #1e293b; color: #f1f5f9; border: 1px solid #334155; }
        .dark-mode .form-control, .dark-mode .form-select { background-color: #334155 !important; border-color: #475569 !important; color: #ffffff !important; }
        .dark-mode .modal-header.bg-light, .dark-mode .modal-body.bg-light { background-color: #1e293b !important; border-color: #334155 !important; }
        .dark-mode .bg-light { background-color: #334155 !important; color: #f1f5f9 !important; }
        .dark-mode .list-group-item { background-color: #1e293b !important; color: #f1f5f9 !important; border-color: #334155 !important; }
        .dark-mode .list-group-item:hover { background-color: #334155 !important; }
        .dark-mode .text-muted { color: #94a3b8 !important; }

        .dark-mode .form-control::placeholder,
        .dark-mode .form-select::placeholder { color: rgba(255, 255, 255, 0.8) !important; opacity: 1; }
        
        #hamburger-btn { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; z-index: 1100; color: var(--text-main); }
        
        .auth-wrapper { height: 100vh; display: flex; align-items: center; justify-content: center; position: relative; }
        #login-section { display: flex; }
        #register-section { display: none; }
        
        #main-dashboard { display: none; position: relative; }
        
        .card { background-color: var(--card-bg); border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: var(--text-main); }
        .stat-card { background: linear-gradient(45deg, #0d6efd, #003d99); color: white; }
        
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; background-size: cover; background-position: center; border: 2px solid var(--accent); }
        .profile-main-img { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem; background-size: cover; background-position: center; border: 3px solid var(--accent); }
        
        .online-dot { width: 10px; height: 10px; background-color: #22c55e; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 8px #22c55e; }
        
        .icon-circle { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px; }
        .icon-circle-success { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; margin: 0 auto 20px; background: #d1e7dd; color: #198754; box-shadow: 0 4px 15px rgba(25,135,84,0.3); }
        
        .edit-img-btn { position: absolute; bottom: 0; right: 0; background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--card-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; }
        .edit-img-btn:hover { background: #0b5ed7; transform: scale(1.1); }
        
        @keyframes heartbeat { 0% { transform: scale(1); } 14% { transform: scale(1.15); } 28% { transform: scale(1); } 42% { transform: scale(1.15); } 70% { transform: scale(1); } }
        .heartbeat-anim { animation: heartbeat 1.5s infinite; }
    </style>
</head>
<body>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="sidebar">
    <div class="text-center mb-4 border-bottom pb-3">
        <div id="menu-avatar" class="profile-main-img shadow-sm mb-2">?</div>
        <button class="btn btn-sm btn-link text-decoration-none fw-bold" onclick="showModal('profileModal')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
        <div class="mt-2 text-start px-3">
            <h6 class="fw-bold mb-0">
                <span class="online-dot"></span>
                <span id="menu-user-name">Loading...</span> 
                <small class="text-success fw-normal" style="font-size: 0.7rem;">Online</small>
            </h6>
            <small class="text-primary fw-bold" id="menu-user-role" style="font-size: 0.85rem;">Admin</small>
        </div>
    </div>
    
    <div class="menu-item" onclick="openHardwareModal()"><i class="bi bi-cpu"></i> <span data-i18n="menu_hw">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span></div>
    <div class="menu-item" onclick="showModal('userListModal')"><i class="bi bi-people"></i> <span data-i18n="menu_users">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></div>
    <div class="menu-item" onclick="showModal('settingsModal')"><i class="bi bi-sliders"></i> <span data-i18n="menu_settings">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ dashboard</span></div>
    
    <hr class="my-4">
    <div class="menu-item" id="logout-btn-side"><i class="bi bi-box-arrow-right"></i> <span data-i18n="menu_logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></div>
    <div class="menu-item danger-item text-danger" onclick="showDeleteSelfModal()"><i class="bi bi-person-x"></i> <span data-i18n="menu_delete">‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span></div>
</div>

<div class="modal fade" id="welcomeModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
      <div class="modal-body text-center p-5">
        <div class="icon-circle-success heartbeat-anim"><i class="bi bi-unlock-fill"></i></div>
        <h3 class="fw-bold mb-3" id="welcome-title" data-i18n="welcome_title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
        <p class="mb-4" id="welcome-message" style="font-size: 1.15rem; color: var(--text-main);"></p>
        <button type="button" class="btn btn-primary px-5 py-2 fw-bold rounded-pill shadow-sm" data-bs-dismiss="modal" data-i18n="welcome_btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteSelfModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-body text-center p-4">
        <div id="delete-step-1">
            <div class="icon-circle bg-danger bg-opacity-10 text-danger"><i class="bi bi-exclamation-triangle-fill"></i></div>
            <h4 class="fw-bold mb-3">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</h4>
            <p class="text-muted small mb-4">‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£</p>
            <div class="d-flex gap-2 justify-content-center">
                <button type="button" class="btn btn-light px-4 fw-bold" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-danger px-4 fw-bold" onclick="nextDeleteSelf()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="bi bi-arrow-right"></i></button>
            </div>
        </div>
        <div id="delete-step-2" style="display:none;">
            <div class="icon-circle bg-danger text-white shadow"><i class="bi bi-shield-lock-fill"></i></div>
            <h5 class="fw-bold mb-3">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h5>
            <input type="password" id="del-self-password" class="form-control mb-4 text-center" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
            <div class="d-flex gap-2 justify-content-center">
                <button type="button" class="btn btn-light px-4 fw-bold" onclick="showDeleteSelfModal()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button type="button" class="btn btn-danger px-4 fw-bold" onclick="confirmDeleteSelf()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£</button>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="userListModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title fw-bold" data-i18n="menu_users">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="full-user-list" class="list-group list-group-flush mb-4"></div>
        <div id="personal-history" style="display:none;">
            <button class="btn btn-sm btn-secondary mb-3" onclick="showFullList()"><i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
            <div class="card p-3 mb-3 bg-primary bg-opacity-10 border-0">
                <h5 class="fw-bold mb-0" id="hist-name">---</h5>
                <p class="small mb-0 text-muted" id="hist-role-label">Role: Visitor</p>
            </div>
            <div class="table-responsive">
                <table class="table table-sm text-center">
                    <thead><tr><th data-i18n="th_date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th data-i18n="th_time">‡πÄ‡∏ß‡∏•‡∏≤</th><th data-i18n="th_device">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th data-i18n="th_status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                    <tbody id="hist-table-body"></tbody>
                </table>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title fw-bold" data-i18n="menu_settings">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ dashboard</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <label class="small fw-bold mb-3" data-i18n="set_display">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</label>
        <button id="dark-mode-toggle-btn" class="btn btn-outline-primary w-100 mb-3 d-flex justify-content-between align-items-center">
            <span data-i18n="set_dark">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î ‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á</span>
            <i id="mode-icon" class="bi bi-moon-stars-fill"></i>
        </button>
        <div class="form-check form-switch mb-4">
            <input class="form-check-input" type="checkbox" id="auto-theme-switch" checked>
            <label class="form-check-label small" data-i18n="set_auto">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (06:00-18:00)</label>
        </div>
        
        <hr class="my-3 border-secondary opacity-25">
        
        <label class="small fw-bold mb-3" data-i18n="set_lang">‡∏†‡∏≤‡∏©‡∏≤ / Language</label>
        <select class="form-select" id="language-select" onchange="changeLanguage(this.value)">
            <option value="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢ (Thai)</option>
            <option value="en">üá¨üáß English</option>
        </select>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title fw-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body text-center">
        <div class="position-relative mx-auto mb-4" style="width: 100px; height: 100px;">
            <div id="p-preview" class="profile-main-img w-100 h-100 m-0"></div>
            <label for="p-img-upload" class="edit-img-btn" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå">
                <i class="bi bi-camera-fill"></i>
            </label>
            <input type="file" id="p-img-upload" accept="image/*" class="d-none" onchange="uploadProfileImage(event)">
        </div>
        
        <div class="text-start">
            <label class="small fw-bold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
            <input type="text" id="p-username" class="form-control mb-3" readonly>
            <label class="small fw-bold mb-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏ß‡πá‡∏ö)</label>
            <input type="password" id="p-new-password" class="form-control mb-3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)">
            <button class="btn btn-primary w-100 fw-bold py-2" onclick="updateUserAuth()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="hwModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-light">
          <h5 class="modal-title fw-bold text-primary"><i class="bi bi-shield-lock"></i> <span data-i18n="menu_hw">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4 bg-light">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h6 class="fw-bold text-primary mb-3"><i class="bi bi-123"></i> 1. Keypad Pin (‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π)</h6>
                <label class="small text-muted mb-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 6 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                <div class="input-group">
                    <input type="text" id="hw-keypad" class="form-control text-center fw-bold fs-5" maxlength="6" placeholder="000000" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    <button class="btn btn-primary px-4 fw-bold" onclick="saveKeypad()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h6 class="fw-bold text-success mb-3"><i class="bi bi-fingerprint"></i> 2. Fingerprint Module</h6>
                <label class="small text-muted mb-2">‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ID (‡πÄ‡∏ä‡πà‡∏ô 01, 04) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠</label>
                <div class="input-group mb-3">
                    <span class="input-group-text bg-success text-white fw-bold border-success">ID</span>
                    <input type="number" id="hw-finger-id" class="form-control border-success" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ID">
                    <button class="btn btn-success fw-bold" id="btn-check-finger" onclick="checkFingerprintID()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                </div>

                <div id="finger-scan-area" class="text-center p-3 bg-success bg-opacity-10 border border-success rounded" style="display:none;">
                    <p id="finger-status-text" class="mb-3 fw-bold text-success">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    <div id="finger-spinner" class="spinner-border text-success mb-3" style="display:none; width: 3rem; height: 3rem;" role="status"></div>
                    <br>
                    <button class="btn btn-success rounded-pill px-4 fw-bold shadow-sm" id="btn-start-finger" onclick="startFingerprintScan()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏Å‡∏ô <i class="bi bi-play-circle-fill ms-1"></i></button>
                    <button class="btn btn-link text-danger text-decoration-none btn-sm mt-2" onclick="cancelScan('finger')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h6 class="fw-bold text-info mb-3"><i class="bi bi-credit-card-2-front-fill"></i> 3. RFID Module (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≤‡∏ö)</h6>
                <label class="small text-muted mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£ RFID ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
                <input type="text" id="hw-rfid-code" class="form-control mb-3 text-center fw-bold text-secondary bg-light" readonly value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£">
                
                <div id="rfid-scan-area" class="text-center p-3 bg-info bg-opacity-10 border border-info rounded">
                    <p id="rfid-status-text" class="mb-3 fw-bold text-info">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà</p>
                    <div id="rfid-spinner" class="spinner-border text-info mb-3" style="display:none; width: 3rem; height: 3rem;" role="status"></div>
                    <br>
                    <button class="btn btn-info text-white rounded-pill px-4 fw-bold shadow-sm" id="btn-start-rfid" onclick="startRFIDScan()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏Å‡∏ô <i class="bi bi-play-circle-fill ms-1"></i></button>
                    <button class="btn btn-link text-danger text-decoration-none btn-sm mt-2" id="btn-cancel-rfid" style="display:none;" onclick="cancelScan('rfid')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="auth-lang-container" class="position-absolute top-0 end-0 p-3 z-3">
    <select class="form-select form-select-sm shadow-sm" id="auth-language-select" onchange="changeLanguage(this.value)" style="width: auto; cursor: pointer; border-radius: 8px;">
        <option value="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
        <option value="en">üá¨üáß English</option>
    </select>
</div>

<div id="login-section" class="auth-wrapper">
    <div class="card p-4 shadow text-center" style="width: 350px;">
        <h3 class="fw-bold mb-1"><i class="bi bi-shield-lock-fill me-2 text-primary"></i><span data-i18n="auth_login_title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span></h3>
        <p class="small opacity-75 mb-4" data-i18n="auth_sys_title">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</p>
        <input type="text" id="username" class="form-control mb-3 py-2" data-i18n="auth_user_ph" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
        <input type="password" id="password" class="form-control mb-3 py-2" data-i18n="auth_pass_ph" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
        <button id="login-btn" class="btn btn-primary w-100 py-2 fw-bold mb-3" data-i18n="auth_login_btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button class="btn btn-link btn-sm text-decoration-none" onclick="showRegisterUI()" data-i18n="auth_no_account">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
        <p id="error-msg" class="text-danger mt-3 small fw-bold"></p>
    </div>
</div>

<div id="register-section" class="auth-wrapper">
    <div class="card p-4 shadow text-center border-top border-success border-4" style="width: 350px;">
        <h3 class="fw-bold mb-1"><i class="bi bi-person-plus-fill me-2 text-success"></i><span data-i18n="auth_reg_title">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</span></h3>
        <p class="small opacity-75 mb-4" data-i18n="auth_reg_sub">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Access Control</p>
        <input type="text" id="reg-username" class="form-control mb-3 py-2" data-i18n="auth_reg_user_ph" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)">
        <input type="password" id="reg-password" class="form-control mb-3 py-2" data-i18n="auth_reg_pass_ph" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)">
        <button id="do-register-btn" class="btn btn-success w-100 py-2 fw-bold mb-3" data-i18n="auth_reg_btn">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
        <button class="btn btn-link btn-sm text-decoration-none text-secondary" onclick="showLoginUI()"><i class="bi bi-arrow-left"></i> <span data-i18n="auth_has_account">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span></button>
        <p id="reg-error-msg" class="text-danger mt-3 small fw-bold"></p>
    </div>
</div>

<div id="main-dashboard">
    <div id="hamburger-btn" onclick="toggleSidebar()"><i class="bi bi-list"></i></div>
    
    <div class="container py-4">
        <header class="mb-4">
            <h1 class="h2 fw-bold text-primary mb-1" data-i18n="title_main">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</h1>
            <p class="opacity-75 mb-3 small" data-i18n="title_sub">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ IoT ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
            <div class="d-flex justify-content-between align-items-end border-top pt-3">
                <div>
                    <div class="d-flex align-items-center gap-3" style="font-size: 1.5rem; font-weight: 600; color: #0d6efd;">
                        <div id="clock-display">--:--:--</div>
                        <div id="live-date" class="small text-secondary" style="font-size: 1rem;">---</div>
                    </div>
                    <div class="small mt-1"><span data-i18n="txt_login_as">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞:</span> <span id="admin-name" class="fw-bold text-success">---</span></div>
                </div>
            </div>
        </header>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card p-4 h-100 border-bottom border-secondary border-3">
                    <h6 class="card-label small fw-bold text-secondary" data-i18n="txt_last_scan">‡πÅ‡∏™‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                    <h2 class="fw-bold my-2"><span id="last-user" data-i18n="wait_data">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span></h2>
                    <div id="last-detail-box" class="mt-2">
                        <span id="last-time" class="small text-muted">---</span>
                        <span id="last-status-badge" class="badge ms-2">---</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-4 h-100 stat-card shadow-lg">
                    <h6 class="text-white opacity-75 fw-bold small" data-i18n="txt_people">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h6>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-people-fill me-3" style="font-size: 2.5rem;"></i>
                        <div><span id="people-count" class="display-5 fw-bold">0</span> <span class="fs-4" data-i18n="txt_unit">‡∏Ñ‡∏ô</span></div>
                    </div>
                    <div id="names-list" class="mt-3 d-flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>

        <div class="card p-4 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0"><i class="bi bi-clock-history me-2"></i><span data-i18n="txt_history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</span></h5>
                <button id="clear-btn" class="btn btn-sm btn-outline-danger px-3" data-i18n="btn_clear">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
            <div class="table-responsive">
                <table class="table align-middle text-center">
                    <thead><tr><th data-i18n="th_date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th data-i18n="th_time">‡πÄ‡∏ß‡∏•‡∏≤</th><th data-i18n="th_name">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th data-i18n="th_device">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th data-i18n="th_status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                    <tbody id="table-body"><tr><td colspan="5" class="text-muted" data-i18n="wait_data">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword, deleteUser, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, remove, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCZ0MK0LRsZLpzAclPxflIa7eWAXAdRchM", 
        databaseURL: "https://smart-access-door-lock-default-rtdb.asia-southeast1.firebasedatabase.app" 
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let allLogs = [];
    let userProfiles = {};
    let currentLoggedInUser = "";
    let fingerUnsub = null;
    let rfidUnsub = null;

    function getRole(username) {
        if(!username) return "Visitor";
        if(username.toLowerCase() === "nonthaphat") return "Admin";
        return "Visitor";
    }

    const i18n = {
        th: {
            menu_hw: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô", menu_users: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", menu_settings: "‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ dashboard",
            menu_logout: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", menu_delete: "‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",
            title_main: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£", 
            title_sub: "‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ IoT ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå",
            txt_login_as: "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞:", txt_last_scan: "‡πÅ‡∏™‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", wait_data: "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
            txt_people: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", txt_unit: "‡∏Ñ‡∏ô",
            txt_history: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å", btn_clear: "‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥",
            th_date: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", th_time: "‡πÄ‡∏ß‡∏•‡∏≤", th_name: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", th_device: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", th_status: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
            set_display: "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•", set_dark: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î ‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á", set_auto: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (06:00-18:00)",
            set_lang: "‡∏†‡∏≤‡∏©‡∏≤ / Language",
            auth_login_title: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", auth_sys_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£",
            auth_user_ph: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", auth_pass_ph: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", auth_login_btn: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
            auth_no_account: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", auth_reg_title: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà",
            auth_reg_sub: "‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Access Control", auth_reg_user_ph: "‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)",
            auth_reg_pass_ph: "‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)", auth_reg_btn: "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
            auth_has_account: "‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
            err_reg_len: "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£",
            msg_creating_acc: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...",
            err_user_exists: "‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß",
            err_general: "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ",
            msg_logging_in: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...",
            err_invalid_login: "‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
            err_cannot_login: "‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ",
            // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏õ‡∏• Pop-up ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ---
            welcome_title: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
            welcome_btn: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
            welcome_admin: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ô‡∏∞ ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö ‡∏Ñ‡∏∏‡∏ì <b>{name}</b>",
            welcome_user: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‡∏Ñ‡∏∏‡∏ì <b>{name}</b>"
        },
        en: {
            menu_hw: "My Door Access", menu_users: "All Users Info", menu_settings: "Dashboard Settings",
            menu_logout: "Logout", menu_delete: "Delete My Account",
            title_main: "Access Control & Door Lock System", 
            title_sub: "IoT-Based Door Lock System with Real-time Dashboard Monitoring",
            txt_login_as: "Logged in as:", txt_last_scan: "Last Entry Scan", wait_data: "Waiting...",
            txt_people: "Current People in Room", txt_unit: "Persons",
            txt_history: "Access History", btn_clear: "Clear History",
            th_date: "Date", th_time: "Time", th_name: "User", th_device: "Device", th_status: "Status",
            set_display: "Display Options", set_dark: "Toggle Dark/Light Mode", set_auto: "Auto theme switch (06:00-18:00)",
            set_lang: "Language / ‡∏†‡∏≤‡∏©‡∏≤",
            auth_login_title: "Login", auth_sys_title: "Access Control & Door Lock System",
            auth_user_ph: "Username", auth_pass_ph: "Password", auth_login_btn: "Login",
            auth_no_account: "Don't have an account? Register", auth_reg_title: "Register",
            auth_reg_sub: "Add new user to Access Control system", auth_reg_user_ph: "Set Username",
            auth_reg_pass_ph: "Set Password (Min 6 chars)", auth_reg_btn: "Register User",
            auth_has_account: "Already have an account? Back to login",
            err_reg_len: "‚ùå Please enter a username and password (min 6 chars)",
            msg_creating_acc: "Creating account...",
            err_user_exists: "‚ùå Username already exists",
            err_general: "‚ùå Error: ",
            msg_logging_in: "Logging in...",
            err_invalid_login: "‚ùå Invalid username or password",
            err_cannot_login: "‚ùå You cannot log in",
            // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏õ‡∏• Pop-up ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ---
            welcome_title: "Login Successful!",
            welcome_btn: "Get Started",
            welcome_admin: "Welcome back, Admin <b>{name}</b>",
            welcome_user: "Welcome to Smart Door System, <b>{name}</b>"
        }
    };

    const getErrMsg = (key) => {
        const lang = localStorage.getItem('dashboard_lang') || 'th';
        return i18n[lang][key] || key;
    };

    window.changeLanguage = (lang) => {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (i18n[lang] && i18n[lang][key]) {
                if(el.tagName === 'INPUT') {
                    el.placeholder = i18n[lang][key];
                } else {
                    el.innerHTML = i18n[lang][key];
                }
            }
        });
        
        if(document.getElementById('language-select')) document.getElementById('language-select').value = lang;
        if(document.getElementById('auth-language-select')) document.getElementById('auth-language-select').value = lang;
        
        localStorage.setItem('dashboard_lang', lang);
        updateClockAndDate();
        
        document.getElementById('error-msg').innerText = '';
        document.getElementById('reg-error-msg').innerText = '';
    };

    const savedLang = localStorage.getItem('dashboard_lang') || 'th';
    document.getElementById('language-select').value = savedLang;
    if(document.getElementById('auth-language-select')) document.getElementById('auth-language-select').value = savedLang;
    changeLanguage(savedLang);

    function applyTheme(isDark) {
        if (isDark) {
            document.body.classList.add('dark-mode');
            document.getElementById('mode-icon').className = "bi bi-sun-fill";
        } else {
            document.body.classList.remove('dark-mode');
            document.getElementById('mode-icon').className = "bi bi-moon-stars-fill";
        }
    }

    document.getElementById('dark-mode-toggle-btn').onclick = () => {
        document.getElementById('auto-theme-switch').checked = false;
        applyTheme(!document.body.classList.contains('dark-mode'));
    };

    window.toggleSidebar = () => {
        document.getElementById('sidebar').classList.toggle('active');
        document.querySelector('.sidebar-overlay').classList.toggle('active');
    };

    window.showModal = (id) => {
        if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
        new bootstrap.Modal(document.getElementById(id)).show();
    };

    window.uploadProfileImage = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_SIZE = 200;
                let width = img.width;
                let height = img.height;
                
                if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                } else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);

                set(ref(db, `users/${currentLoggedInUser}/profile_img`), dataUrl).then(() => {
                    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
                }).catch(err => {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ: ' + err.message);
                });
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    };

    window.openHardwareModal = () => {
        if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
        const data = userProfiles[currentLoggedInUser];
        
        cancelScan('finger'); cancelScan('rfid');

        if(data) {
            document.getElementById('hw-keypad').value = data.keypad_pin || '000000';
            document.getElementById('hw-finger-id').value = data.fingerprint_id || '';
            document.getElementById('hw-rfid-code').value = data.rfid_code || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£';
            
            if(data.rfid_code) {
                document.getElementById('btn-start-rfid').innerHTML = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFID code <i class="bi bi-pencil-square ms-1"></i>`;
            } else {
                document.getElementById('btn-start-rfid').innerHTML = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏Å‡∏ô <i class="bi bi-play-circle-fill ms-1"></i>`;
            }
        }
        new bootstrap.Modal(document.getElementById('hwModal')).show();
    };

    window.saveKeypad = () => {
        const val = document.getElementById('hw-keypad').value;
        if(val.length === 6) {
            set(ref(db, `users/${currentLoggedInUser}/keypad_pin`), val).then(() => {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
            });
        } else {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 6 ‡∏´‡∏•‡∏±‡∏Å");
        }
    };

    window.checkFingerprintID = () => {
        const id = document.getElementById('hw-finger-id').value;
        if(!id) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ ID ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô");
        
        let exists = false;
        for(let key in userProfiles) {
            if(userProfiles[key].fingerprint_id == id && key !== currentLoggedInUser) {
                exists = true; break;
            }
        }
        
        if(exists) {
            if(!confirm(`‡∏°‡∏µ‡πÑ‡∏≠‡∏î‡∏µ ${id} ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
        }
        
        document.getElementById('finger-scan-area').style.display = 'block';
        document.getElementById('btn-check-finger').innerText = "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ID ‡πÉ‡∏´‡∏°‡πà";
    };

    window.startFingerprintScan = () => {
        const id = document.getElementById('hw-finger-id').value;
        document.getElementById('finger-spinner').style.display = 'inline-block';
        document.getElementById('btn-start-finger').style.display = 'none';
        document.getElementById('finger-status-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏Å‡∏ô‡∏ô‡∏¥‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1 (‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)...";
        document.getElementById('finger-status-text').className = "mb-3 fw-bold text-primary";

        set(ref(db, 'commands/fingerprint'), { command: 'enroll', id: id, user: currentLoggedInUser, status: 'waiting_1' });

        if(fingerUnsub) fingerUnsub();
        fingerUnsub = onValue(ref(db, 'commands/fingerprint/status'), (snap) => {
            const status = snap.val();
            if(status === 'waiting_2') {
                Swal.fire({ icon: 'info', title: '‡πÅ‡∏™‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1 ‡∏ú‡πà‡∏≤‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á!', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' });
                document.getElementById('finger-status-text').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á...";
                document.getElementById('finger-status-text').className = "mb-3 fw-bold text-warning";
            } else if(status === 'success') {
                document.getElementById('finger-status-text').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                document.getElementById('finger-status-text').className = "mb-3 fw-bold text-success";
                document.getElementById('finger-spinner').style.display = 'none';
                document.getElementById('btn-start-finger').style.display = 'inline-block';
                document.getElementById('btn-start-finger').innerHTML = `‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á <i class="bi bi-arrow-repeat ms-1"></i>`;
                
                set(ref(db, `users/${currentLoggedInUser}/fingerprint_id`), id);
                if(fingerUnsub) { fingerUnsub(); fingerUnsub = null; }
            } else if(status === 'failed' || status === 'mismatch') {
                document.getElementById('finger-status-text').innerText = "‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà";
                document.getElementById('finger-status-text').className = "mb-3 fw-bold text-danger";
                document.getElementById('finger-spinner').style.display = 'none';
                document.getElementById('btn-start-finger').style.display = 'inline-block';
                document.getElementById('btn-start-finger').innerHTML = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà <i class="bi bi-play-circle-fill ms-1"></i>`;
                if(fingerUnsub) { fingerUnsub(); fingerUnsub = null; }
            }
        });
    };

    window.startRFIDScan = () => {
        document.getElementById('rfid-spinner').style.display = 'inline-block';
        document.getElementById('btn-start-rfid').style.display = 'none';
        document.getElementById('btn-cancel-rfid').style.display = 'inline-block';
        document.getElementById('rfid-status-text').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ï‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô...";
        document.getElementById('rfid-status-text').className = "mb-3 fw-bold text-primary";

        set(ref(db, 'commands/rfid'), { command: 'enroll', user: currentLoggedInUser, status: 'waiting', scanned_code: '' });

        if(rfidUnsub) rfidUnsub();
        rfidUnsub = onValue(ref(db, 'commands/rfid'), (snap) => {
            const data = snap.val();
            if(!data) return;
            
            if(data.status === 'success' && data.scanned_code) {
                document.getElementById('rfid-status-text').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                document.getElementById('rfid-status-text').className = "mb-3 fw-bold text-success";
                document.getElementById('rfid-spinner').style.display = 'none';
                document.getElementById('btn-start-rfid').style.display = 'inline-block';
                document.getElementById('btn-cancel-rfid').style.display = 'none';
                document.getElementById('btn-start-rfid').innerHTML = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFID code <i class="bi bi-pencil-square ms-1"></i>`;
                
                document.getElementById('hw-rfid-code').value = data.scanned_code;
                set(ref(db, `users/${currentLoggedInUser}/rfid_code`), data.scanned_code);
                
                if(rfidUnsub) { rfidUnsub(); rfidUnsub = null; }
            } else if(data.status === 'failed') {
                document.getElementById('rfid-status-text').innerText = "‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
                document.getElementById('rfid-status-text').className = "mb-3 fw-bold text-danger";
                document.getElementById('rfid-spinner').style.display = 'none';
                document.getElementById('btn-start-rfid').style.display = 'inline-block';
                document.getElementById('btn-cancel-rfid').style.display = 'none';
                document.getElementById('btn-start-rfid').innerHTML = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà <i class="bi bi-play-circle-fill ms-1"></i>`;
                if(rfidUnsub) { rfidUnsub(); rfidUnsub = null; }
            }
        });
    };

    window.cancelScan = (type) => {
        if(type === 'finger') {
            document.getElementById('finger-scan-area').style.display = 'none';
            document.getElementById('finger-spinner').style.display = 'none';
            document.getElementById('btn-start-finger').style.display = 'inline-block';
            document.getElementById('btn-check-finger').innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà";
            set(ref(db, 'commands/fingerprint/command'), 'idle');
            if(fingerUnsub) { fingerUnsub(); fingerUnsub = null; }
        } else {
            document.getElementById('rfid-status-text').innerText = "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà";
            document.getElementById('rfid-status-text').className = "mb-3 fw-bold text-info";
            document.getElementById('rfid-spinner').style.display = 'none';
            document.getElementById('btn-start-rfid').style.display = 'inline-block';
            document.getElementById('btn-cancel-rfid').style.display = 'none';
            set(ref(db, 'commands/rfid/command'), 'idle');
            if(rfidUnsub) { rfidUnsub(); rfidUnsub = null; }
        }
    };

    window.showDeleteSelfModal = () => {
        if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
        document.getElementById('delete-step-1').style.display = 'block';
        document.getElementById('delete-step-2').style.display = 'none';
        document.getElementById('del-self-password').value = '';
        new bootstrap.Modal(document.getElementById('deleteSelfModal')).show();
    };
    window.nextDeleteSelf = () => { document.getElementById('delete-step-1').style.display = 'none'; document.getElementById('delete-step-2').style.display = 'block'; };
    window.confirmDeleteSelf = () => {
        const pass = document.getElementById('del-self-password').value;
        const user = auth.currentUser;
        if(!user || !pass) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô');
        const credential = EmailAuthProvider.credential(user.email, pass);
        reauthenticateWithCredential(user, credential).then(() => {
            const uName = user.email.split('@')[0];
            remove(ref(db, 'users/' + uName)).then(() => {
                deleteUser(user).then(() => { alert('‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); bootstrap.Modal.getInstance(document.getElementById('deleteSelfModal')).hide(); });
            });
        }).catch(() => alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
    };

    window.showRegisterUI = () => {
        document.getElementById('login-section').style.display = 'none'; document.getElementById('register-section').style.display = 'flex';
        document.getElementById('reg-error-msg').innerText = ''; document.getElementById('reg-username').value = ''; document.getElementById('reg-password').value = '';
    };
    window.showLoginUI = () => { document.getElementById('register-section').style.display = 'none'; document.getElementById('login-section').style.display = 'flex'; document.getElementById('error-msg').innerText = ''; };

    document.getElementById('do-register-btn').onclick = () => {
        const u = document.getElementById('reg-username').value.trim();
        const p = document.getElementById('reg-password').value;
        if(!u || p.length < 6) { document.getElementById('reg-error-msg').innerText = getErrMsg('err_reg_len'); return; }
        
        document.getElementById('reg-error-msg').innerHTML = `<span class='text-primary'>${getErrMsg('msg_creating_acc')}</span>`;
        sessionStorage.setItem('justLoggedIn', 'true'); 
        createUserWithEmailAndPassword(auth, u + "@insight.com", p).then(() => {
            set(ref(db, 'users/' + u), { username: u, keypad_pin: "000000" });
        }).catch(e => {
            sessionStorage.removeItem('justLoggedIn');
            document.getElementById('reg-error-msg').innerText = (e.code === 'auth/email-already-in-use') ? getErrMsg('err_user_exists') : getErrMsg('err_general') + e.message;
        });
    };

    window.updateUserAuth = () => {
        const newPass = document.getElementById('p-new-password').value;
        if(newPass.length >= 6 && auth.currentUser) {
            updatePassword(auth.currentUser, newPass).then(() => { alert("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); document.getElementById('p-new-password').value = ''; });
        } else { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£"); }
    };

    document.getElementById('login-btn').onclick = () => {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value;
        document.getElementById('error-msg').innerHTML = `<span class='text-primary'>${getErrMsg('msg_logging_in')}</span>`;
        sessionStorage.setItem('justLoggedIn', 'true'); 
        signInWithEmailAndPassword(auth, u + "@insight.com", p).catch(() => {
            sessionStorage.removeItem('justLoggedIn');
            document.getElementById('error-msg').innerText = getErrMsg('err_invalid_login');
        });
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            const uName = user.email.split('@')[0];
            const targetUser = uName.toLowerCase();
            currentLoggedInUser = targetUser;
            
            get(ref(db, 'users/' + targetUser)).then((snapshot) => {
                if (!snapshot.exists()) {
                    signOut(auth).then(() => {
                        document.getElementById('error-msg').innerHTML = getErrMsg('err_cannot_login');
                        sessionStorage.removeItem('justLoggedIn');
                    });
                    return;
                }
                
                document.getElementById('auth-lang-container').style.display = 'none';
                
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('register-section').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                
                document.getElementById('admin-name').innerText = uName;
                document.getElementById('p-username').value = uName;
                document.getElementById('menu-user-name').innerText = uName;
                document.getElementById('menu-user-role').innerText = getRole(uName);
                
                onValue(ref(db, 'users'), (snap) => {
                    userProfiles = snap.val() || {};
                    updateSidebarAvatar(uName);
                    updateFullUserList(); 
                });
                runAppLogs();

                if (sessionStorage.getItem('justLoggedIn') === 'true') {
                    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å i18n ---
                    const lang = localStorage.getItem('dashboard_lang') || 'th';
                    let welcomeTemplate = targetUser === 'nonthaphat' 
                        ? i18n[lang].welcome_admin
                        : i18n[lang].welcome_user;
                        
                    let welcomeText = welcomeTemplate.replace('{name}', uName);
                    
                    document.getElementById('welcome-message').innerHTML = welcomeText;
                    new bootstrap.Modal(document.getElementById('welcomeModal')).show();
                    sessionStorage.removeItem('justLoggedIn');
                }
            });
        } else {
            currentLoggedInUser = "";
            
            document.getElementById('auth-lang-container').style.display = 'block';
            
            document.getElementById('login-section').style.display = 'flex';
            document.getElementById('register-section').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            if(document.getElementById('error-msg').innerHTML.includes("text-primary")) {
                document.getElementById('error-msg').innerText = '';
            }
        }
    });

    function updateSidebarAvatar(uName) {
        const userData = userProfiles[uName];
        if(!userData) return;
        
        const color = getColorFromName(uName);
        const els = [document.getElementById('menu-avatar'), document.getElementById('p-preview')];
        
        els.forEach(el => {
            if (userData.profile_img) {
                el.style.backgroundImage = `url(${userData.profile_img})`;
                el.innerText = '';
                el.style.backgroundColor = 'transparent';
            } else {
                el.style.backgroundImage = "none";
                el.style.backgroundColor = color;
                el.innerText = uName[0].toUpperCase();
            }
        });
    }

    function updateFullUserList() {
        const list = document.getElementById('full-user-list');
        list.innerHTML = "";
        
        const keys = Object.keys(userProfiles);
        if(keys.length === 0) { list.innerHTML = "<div class='text-center text-muted py-3'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>"; return; }

        keys.forEach(key => {
            const userData = userProfiles[key];
            if (!userData || !userData.username) return; 
            
            const uName = userData.username;
            const targetUser = uName.toLowerCase();
            const role = getRole(uName); 
            const currentRole = getRole(currentLoggedInUser); 
            const isSelf = (targetUser === currentLoggedInUser);
            
            let canDelete = false;
            if (currentRole === 'Admin') canDelete = !isSelf;
            
            let deleteBtnHtml = canDelete ? `<button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteUserProfile('${uName}', event)" title="‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"><i class="bi bi-trash"></i></button>` : '';
            
            let avatarHtml = '';
            if (userData.profile_img) {
                avatarHtml = `<div class="user-avatar me-3" style="background-image:url(${userData.profile_img}); background-color:transparent; cursor:pointer;" onclick="showPersonalHistory('${uName}')"></div>`;
            } else {
                avatarHtml = `<div class="user-avatar me-3" style="background:${getColorFromName(uName)}; cursor:pointer;" onclick="showPersonalHistory('${uName}')">${uName[0].toUpperCase()}</div>`;
            }
            
            list.insertAdjacentHTML('beforeend', `
                <div class="list-group-item list-group-item-action d-flex align-items-center py-3">
                    ${avatarHtml}
                    <div class="flex-grow-1" onclick="showPersonalHistory('${uName}')" style="cursor:pointer;">
                        <div class="fw-bold">${uName} ${isSelf ? '<span class="badge bg-primary ms-1" style="font-size:0.6rem;" data-i18n="txt_you">‡∏Ñ‡∏∏‡∏ì</span>' : ''}</div>
                        <small class="${role === 'Admin' ? 'text-danger fw-bold' : 'text-primary'}">${role}</small>
                    </div>
                    ${deleteBtnHtml}
                    <i class="bi bi-chevron-right ms-3 text-muted" onclick="showPersonalHistory('${uName}')" style="cursor:pointer;"></i>
                </div>
            `);
        });
        
        const currentLang = localStorage.getItem('dashboard_lang') || 'th';
        document.querySelectorAll('[data-i18n="txt_you"]').forEach(el => {
            el.innerText = currentLang === 'en' ? 'You' : '‡∏Ñ‡∏∏‡∏ì';
        });
    }

    window.deleteUserProfile = (uName, event) => {
        event.stopPropagation(); 
        if(confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á "${uName}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) remove(ref(db, 'users/' + uName)).then(() => alert(`‡∏•‡∏ö ${uName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`));
    };

    window.showPersonalHistory = (name) => {
        document.getElementById('full-user-list').style.display = 'none'; document.getElementById('personal-history').style.display = 'block';
        document.getElementById('hist-name').innerText = name; document.getElementById('hist-role-label').innerText = "Role: " + getRole(name);
        
        const logs = allLogs.filter(l => l.name === name).reverse();
        if(logs.length === 0) document.getElementById('hist-table-body').innerHTML = "<tr><td colspan='4' class='text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</td></tr>";
        else document.getElementById('hist-table-body').innerHTML = logs.map(l => `<tr><td>${l.date}</td><td>${l.timestamp}</td><td>${l.type}</td><td><span class="badge ${l.status=='In'?'bg-success':'bg-danger'}">${l.status}</span></td></tr>`).join('');
    };

    window.showFullList = () => { document.getElementById('full-user-list').style.display = 'block'; document.getElementById('personal-history').style.display = 'none'; };

    function runAppLogs() {
        onValue(ref(db, 'access_logs'), (snap) => {
            allLogs = []; const tbody = document.getElementById('table-body'); tbody.innerHTML = ""; let peopleIn = [];
            
            if(!snap.exists()) {
                tbody.innerHTML = "<tr><td colspan='5' class='text-muted py-3' data-i18n='wait_data'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>";
                document.getElementById('people-count').innerText = "0"; document.getElementById('names-list').innerHTML = ""; document.getElementById('last-user').innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; return;
            }

            snap.forEach(c => {
                const d = c.val(); const displayName = d.name || "Unknown";
                allLogs.push({...d, name: displayName});
                const bClass = d.status == 'In' ? 'bg-success' : 'bg-danger';
                tbody.insertAdjacentHTML('afterbegin', `<tr><td>${d.date}</td><td>${d.timestamp}</td><td class="fw-bold">${displayName}</td><td><small>${d.type}</small></td><td><span class="badge ${bClass}">${d.status}</span></td></tr>`);
                if(d.status == "In") { if(!peopleIn.includes(displayName)) peopleIn.push(displayName); } else { peopleIn = peopleIn.filter(p => p !== displayName); }
            });
            
            document.getElementById('people-count').innerText = peopleIn.length;
            document.getElementById('names-list').innerHTML = peopleIn.map(n => `<div class="bg-white bg-opacity-10 rounded-pill px-3 py-1 border small fw-bold">${n}</div>`).join('');
            
            if(allLogs.length > 0) {
                const last = allLogs[allLogs.length-1];
                document.getElementById('last-user').innerText = last.name; document.getElementById('last-time').innerText = last.date + " " + last.timestamp;
                const lb = document.getElementById('last-status-badge'); lb.innerText = last.status; lb.className = `badge ms-2 ${last.status=='In'?'bg-success':'bg-danger'}`;
            }
        });
    }

    function getColorFromName(name) {
        if(!name) return '#000';
        const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#009688', '#4caf50', '#ff9800'];
        let hash = 0; for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        return colors[Math.abs(hash) % colors.length];
    }

    function updateClockAndDate() {
        const now = new Date();
        const currentLang = localStorage.getItem('dashboard_lang') || 'th';
        const locale = currentLang === 'en' ? 'en-US' : 'th-TH';
        
        document.getElementById('clock-display').innerText = now.toLocaleTimeString(locale, { hour12: false });
        
        const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        document.getElementById('live-date').innerText = now.toLocaleDateString(locale, dateOptions);
    }

    setInterval(() => {
        updateClockAndDate();
        if(document.getElementById('auto-theme-switch').checked) { 
            const hour = new Date().getHours(); 
            applyTheme(hour < 6 || hour >= 18); 
        }
    }, 1000);

    if(document.getElementById('logout-btn-side')) document.getElementById('logout-btn-side').onclick = () => { signOut(auth).then(() => { document.getElementById('error-msg').innerText = ''; }); };
    if(document.getElementById('clear-btn')) document.getElementById('clear-btn').onclick = () => { if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)")) remove(ref(db, 'access_logs')); };
</script>
</body>
</html>
