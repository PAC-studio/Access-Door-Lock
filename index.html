<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Entry Door Lock Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root { 
            --bg-color: #f8f9fa; --card-bg: #ffffff; --text-main: #212529; --border-color: #dee2e6; --accent: #0d6efd; 
        }
        /* Dark Mode: ห้ามสีขาว ห้ามตัวอักษรดำ */
        body.dark-mode { 
            --bg-color: #1a1a1a; --card-bg: #2d2d2d; --text-main: #e0e0e0; --border-color: #444444; --accent: #3786ff; 
        }

        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Kanit', sans-serif; transition: 0.3s; overflow-x: hidden; }
        
        /* Sidebar Menu */
        .sidebar { position: fixed; left: -280px; top: 0; height: 100%; width: 280px; background: var(--card-bg); z-index: 2000; transition: 0.3s; box-shadow: 4px 0 10px rgba(0,0,0,0.2); border-right: 1px solid var(--border-color); }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .menu-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border-color); color: var(--text-main); text-decoration: none; }
        .menu-item:hover { background: rgba(0,0,0,0.05); }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display:none; z-index: 1500; }
        
        .hamburger { font-size: 24px; cursor: pointer; color: var(--text-main); position: absolute; top: 15px; left: 15px; z-index: 1000; }

        /* Dark Mode Table Fixes */
        .dark-mode .table { color: #e0e0e0 !important; --bs-table-bg: #333333 !important; border-color: #444; }
        .dark-mode .table-light { --bs-table-bg: #3d3d3d !important; color: #ffffff !important; }
        .dark-mode .form-control { background: #3d3d3d !important; border-color: #555 !important; color: #fff !important; }
        .dark-mode .modal-content { background: #2d2d2d; color: #e0e0e0; border: 1px solid #444; }

        /* Loader */
        #loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white; }
        
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; background-size: cover; background-position: center; }
        .stat-card { background: linear-gradient(45deg, #0d6efd, #003d99); color: white; border-radius: 12px; }
        #main-dashboard { display: none; padding-top: 60px; }
    </style>
</head>
<body>

<div id="loader-overlay">
    <div class="spinner-border text-primary mb-3"></div>
    <h5 id="loader-text">กำลังสื่อสารกับบอร์ด...</h5>
</div>

<div class="overlay" id="overlay"></div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header d-flex justify-content-between align-items-center">
        <h5 class="fw-bold mb-0">เมนูควบคุม</h5>
        <i class="bi bi-x-lg cursor-pointer" id="close-menu"></i>
    </div>
    <div class="menu-item" data-bs-toggle="modal" data-bs-target="#profileModal">
        <i class="bi bi-person-circle"></i> 1. จัดการโปรไฟล์
    </div>
    <div class="menu-item" data-bs-toggle="modal" data-bs-target="#deviceModal">
        <i class="bi bi-key-fill"></i> 2. แก้ไขรหัสผ่านอุปกรณ์
    </div>
    <div class="menu-item" data-bs-toggle="modal" data-bs-target="#memberModal">
        <i class="bi bi-people-fill"></i> 3. ข้อมูลผู้ใช้ทั้งหมด
    </div>
    <div class="menu-item" data-bs-toggle="modal" data-bs-target="#configModal">
        <i class="bi bi-gear-fill"></i> 4. ตั้งค่า Dashboard
    </div>
    <div class="menu-item text-danger" id="logout-btn">
        <i class="bi bi-box-arrow-right"></i> ออกจากระบบ
    </div>
</div>

<i class="bi bi-list hamburger" id="open-menu"></i>

<div class="modal fade" id="profileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5>จัดการโปรไฟล์</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center">
                <div id="p-preview" class="user-avatar mx-auto mb-3" style="width: 100px; height: 100px; font-size: 2.5rem;"></div>
                <input type="file" id="p-upload" hidden accept="image/*">
                <button class="btn btn-outline-primary btn-sm mb-3" onclick="document.getElementById('p-upload').click()">แก้ไขรูปโปรไฟล์</button>
                <div class="text-start">
                    <label class="small fw-bold">ชื่อผู้ใช้ (Login ID)</label>
                    <input type="text" id="p-username-display" class="form-control mb-2" readonly>
                    <label class="small fw-bold">เปลี่ยนชื่อผู้ใช้ใหม่</label>
                    <input type="text" id="p-new-username" class="form-control mb-2" placeholder="PACadmin001">
                    <label class="small fw-bold">เปลี่ยนรหัสผ่าน Login</label>
                    <input type="password" id="p-new-password" class="form-control mb-3" placeholder="กรอกรหัสใหม่เพื่อเปลี่ยน">
                </div>
                <button class="btn btn-primary w-100" onclick="updateLoginProfile()">บันทึกข้อมูล (รหัสเก่าจะใช้ไม่ได้)</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5>แก้ไขรหัสสำหรับใช้เป็นรหัสผ่านเข้า-ออก</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <h6>1. Keypad System</h6>
                <div class="input-group mb-4">
                    <input type="text" id="keypad-code" class="form-control" maxlength="6" value="000000">
                    <button class="btn btn-success" onclick="saveKeypad()">อัปเดต Keypad</button>
                </div>
                <hr>
                <h6>2. Fingerprint Module</h6>
                <div class="row g-2 mb-4">
                    <div class="col-8">
                        <input type="number" id="finger-id" class="form-control" placeholder="ระบุ ID เช่น 01">
                    </div>
                    <div class="col-4">
                        <button class="btn btn-warning w-100" onclick="checkFingerID()">เริ่มการแสกน</button>
                    </div>
                </div>
                <hr>
                <h6>3. RFID Module</h6>
                <div id="rfid-section">
                    <p class="small text-muted">รหัสปัจจุบัน: <span id="rfid-current-code">ยังไม่มีข้อมูล</span></p>
                    <button class="btn btn-info w-100 text-white" id="rfid-btn" onclick="startScanRFID()">เริ่มการแสกนบัตร</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="memberModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5>ข้อมูลผู้ใช้ทั้งหมดในระบบ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div id="member-list" class="list-group"></div>
                <div id="member-detail" style="display:none;" class="mt-3">
                    <button class="btn btn-sm btn-secondary mb-2" onclick="toggleMemberView(false)">ย้อนกลับ</button>
                    <h5 id="detail-name"></h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>วันที่</th><th>เวลา</th><th>อุปกรณ์</th><th>สถานะ</th></tr></thead>
                            <tbody id="detail-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header"><h5>ตั้งค่า Dashboard</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <label class="small fw-bold">ภาษา / Language</label>
                <select class="form-select mb-3" id="lang-select">
                    <option value="th">ภาษาไทย</option>
                    <option value="en">English</option>
                </select>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="theme-switch">
                    <label class="form-check-label">โหมดมืด (เปิด/ปิดเอง)</label>
                </div>
                <p class="small text-muted mt-2">*ระบบจะเปลี่ยนโหมดอัตโนมัติตามเวลา (06:00-18:00)</p>
            </div>
        </div>
    </div>
</div>

<div id="login-section" class="container">
    <div class="row justify-content-center align-items-center" style="height: 100vh;">
        <div class="col-md-4">
            <div class="card p-4 shadow-lg text-center">
                <h3 class="fw-bold mb-4">เข้าสู่ระบบ</h3>
                <input type="text" id="login-u" class="form-control mb-3" placeholder="ชื่อผู้ใช้">
                <input type="password" id="login-p" class="form-control mb-3" placeholder="รหัสผ่าน">
                <button class="btn btn-primary w-100 fw-bold py-2" id="btn-do-login">Login</button>
                <p id="login-err" class="text-danger mt-3 small"></p>
                <button class="btn btn-link btn-sm mt-2" onclick="showSignup()">สมัครสมาชิกใหม่</button>
            </div>
        </div>
    </div>
</div>

<div id="main-dashboard" class="container">
    <header class="mb-4 text-center">
        <h2 class="fw-bold text-primary">Access Entry Door Lock</h2>
        <div id="clock-display" class="fs-4 fw-bold">--:--:--</div>
        <div id="live-date" class="small opacity-75">---</div>
    </header>

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card p-4 h-100 border-start border-primary border-4 shadow-sm">
                <h6 class="text-muted fw-bold">สแกนล่าสุด</h6>
                <h2 id="last-user" class="fw-bold my-2">---</h2>
                <div id="last-info" class="small">---</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-4 h-100 stat-card shadow-lg">
                <h6 class="text-white-50 fw-bold">จำนวนคนในห้อง</h6>
                <div class="display-4 fw-bold"><span id="people-count">0</span> คน</div>
                <div id="names-list" class="mt-2 d-flex flex-wrap gap-2"></div>
            </div>
        </div>
    </div>

    <div class="card p-4 shadow-sm">
        <h5 class="fw-bold mb-3"><i class="bi bi-clock-history me-2"></i>ประวัติการเข้า-ออก</h5>
        <div class="table-responsive">
            <table class="table table-hover align-middle text-center">
                <thead class="table-light">
                    <tr><th>วันที่</th><th>เวลา</th><th>ชื่อผู้ใช้</th><th>อุปกรณ์</th><th>สถานะ</th></tr>
                </thead>
                <tbody id="main-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCZ0MK0LRsZLpzAclPxflIa7eWAXAdRchM", 
        databaseURL: "https://smart-access-door-lock-default-rtdb.asia-southeast1.firebasedatabase.app" 
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let allLogs = [];
    let allUsers = {};
    let currentUserData = {};

    // --- 1. UI CONTROL ---
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    document.getElementById('open-menu').onclick = () => { sidebar.classList.add('active'); overlay.style.display = 'block'; };
    document.getElementById('close-menu').onclick = overlay.onclick = () => { sidebar.classList.remove('active'); overlay.style.display = 'none'; };

    // --- 2. THEME LOGIC (06:00 - 18:00) ---
    function checkTheme() {
        const hour = new Date().getHours();
        const isAutoDark = hour < 6 || hour >= 18;
        if (isAutoDark) document.body.classList.add('dark-mode');
        else document.body.classList.remove('dark-mode');
        document.getElementById('theme-switch').checked = document.body.classList.contains('dark-mode');
    }
    checkTheme();
    setInterval(checkTheme, 60000);
    document.getElementById('theme-switch').onchange = (e) => {
        if(e.target.checked) document.body.classList.add('dark-mode');
        else document.body.classList.remove('dark-mode');
    };

    // --- 3. CLOCK ---
    setInterval(() => {
        const now = new Date();
        document.getElementById('clock-display').innerText = now.toLocaleTimeString('th-TH');
        document.getElementById('live-date').innerText = now.toLocaleDateString('th-TH', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
    }, 1000);

    // --- 4. AUTH LOGIC ---
    document.getElementById('btn-do-login').onclick = () => {
        const u = document.getElementById('login-u').value, p = document.getElementById('login-p').value;
        signInWithEmailAndPassword(auth, u + "@insight.com", p).catch(err => document.getElementById('login-err').innerText = "รหัสผ่านหรือชื่อผู้ใช้ผิด");
    };

    document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => location.reload());

    onAuthStateChanged(auth, user => {
        if (user) {
            const uID = user.email.split('@')[0];
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            document.getElementById('p-username-display').value = uID;
            loadData();
        } else {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('main-dashboard').style.display = 'none';
        }
    });

    // --- 5. DATA LOADING ---
    function loadData() {
        // Load All Users for Member List
        onValue(ref(db, 'users'), snap => {
            allUsers = snap.val() || {};
            renderMemberList();
            if(auth.currentUser) {
                currentUserData = allUsers[auth.currentUser.uid] || {};
                updateProfileUI();
            }
        });

        // Load Logs
        onValue(ref(db, 'access_logs'), snap => {
            allLogs = [];
            const body = document.getElementById('main-table-body'); body.innerHTML = '';
            let pins = [];
            snap.forEach(child => {
                const d = child.val(); allLogs.push(d);
                const badge = d.status == 'In' ? 'bg-success' : 'bg-danger';
                body.insertAdjacentHTML('afterbegin', `<tr><td>${d.date}</td><td>${d.timestamp}</td><td class="fw-bold">${d.name}</td><td>${d.type}</td><td><span class="badge ${badge}">${d.status}</span></td></tr>`);
                if(d.status == 'In') pins.push(d.name); else pins = pins.filter(p => p !== d.name);
            });
            const last = allLogs[allLogs.length - 1];
            if(last) {
                document.getElementById('last-user').innerText = last.name;
                document.getElementById('last-info').innerText = `${last.date} | ${last.timestamp} | ${last.type}`;
            }
            document.getElementById('people-count').innerText = pins.length;
            renderPeopleInRoom(pins);
        });
    }

    // --- 6. PROFILE SYSTEM ---
    function updateProfileUI() {
        const u = auth.currentUser;
        const name = u.email.split('@')[0];
        const preview = document.getElementById('p-preview');
        if(currentUserData.photo) {
            preview.style.backgroundImage = `url(${currentUserData.photo})`;
            preview.innerText = "";
        } else {
            preview.style.backgroundColor = currentUserData.color || '#0d6efd';
            preview.innerText = name.charAt(0).toUpperCase();
            preview.style.backgroundImage = "none";
        }
    }

    window.updateLoginProfile = async () => {
        const user = auth.currentUser;
        const newPass = document.getElementById('p-new-password').value;
        const newU = document.getElementById('p-new-username').value;
        
        try {
            if(newPass.length >= 6) {
                await updatePassword(user, newPass);
                alert("เปลี่ยนรหัสผ่านสำเร็จ! กรุณาล็อกอินใหม่");
                signOut(auth);
                return;
            }
            if(newU) {
                alert("บันทึกชื่อผู้ใช้ใหม่ (ฟีเจอร์นี้ต้องใช้ Admin SDK หรือ Re-auth)");
            }
        } catch(e) { alert(e.message); }
    };

    document.getElementById('p-upload').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = () => {
            update(ref(db, 'users/' + auth.currentUser.uid), { photo: reader.result });
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    // --- 7. DEVICE CONTROL (Finger/RFID/Keypad) ---
    window.saveKeypad = () => {
        const code = document.getElementById('keypad-code').value;
        if(code.length === 6) set(ref(db, 'settings/keypad'), code).then(() => alert("OK"));
    };

    window.checkFingerID = () => {
        const id = document.getElementById('finger-id').value;
        let exists = false;
        Object.values(allUsers).forEach(u => { if(u.fingerID == id) exists = true; });

        if(exists && !confirm("ID นี้มีในระบบแล้ว ต้องการเขียนทับหรือไม่?")) return;
        startBoardAction("enroll", "finger", id);
    };

    window.startScanRFID = () => startBoardAction("enroll", "rfid", "0");

    function startBoardAction(action, type, id) {
        document.getElementById('loader-overlay').style.display = 'flex';
        const cmdRef = ref(db, 'board_cmd');
        set(cmdRef, { action, type, id, status: "wait" });

        const unsub = onValue(cmdRef, snap => {
            const val = snap.val();
            if(val?.status === "scan1") document.getElementById('loader-text').innerText = "กรุณาวางลายนิ้วมือครั้งที่ 1...";
            if(val?.status === "scan2") alert("กรุณาวางลายนิ้วมืออีกครั้ง (ยืนยัน)");
            if(val?.status === "success") {
                document.getElementById('loader-overlay').style.display = 'none';
                alert("สำเร็จ!");
                set(cmdRef, null);
                unsub();
            }
            if(val?.status === "fail") {
                alert("ล้มเหลว! แสกนไม่ตรงกันหรือหมดเวลา");
                document.getElementById('loader-overlay').style.display = 'none';
                set(cmdRef, null);
                unsub();
            }
        });
    }

    // --- 8. MEMBER & ROOM UI ---
    function renderPeopleInRoom(names) {
        const container = document.getElementById('names-list'); container.innerHTML = '';
        names.forEach(name => {
            let userData = {};
            Object.values(allUsers).forEach(u => { if(u.displayName == name) userData = u; });
            const color = userData.color || '#fff';
            const img = userData.photo ? `background-image:url(${userData.photo})` : `background-color:${color}`;
            container.insertAdjacentHTML('beforeend', `
                <div class="d-flex align-items-center bg-white bg-opacity-10 rounded-pill pe-3 border border-light border-opacity-25">
                    <div class="user-avatar me-2" style="width:30px; height:30px; font-size:12px; ${img}">${userData.photo?'':name.charAt(0)}</div>
                    <span class="small text-white">${name}</span>
                </div>
            `);
        });
    }

    function renderMemberList() {
        const list = document.getElementById('member-list'); list.innerHTML = '';
        Object.keys(allUsers).forEach(uid => {
            const u = allUsers[uid];
            list.insertAdjacentHTML('beforeend', `
                <button class="list-group-item list-group-item-action d-flex justify-content-between" onclick="showUserHistory('${u.displayName}')">
                    <span>${u.displayName || 'Unnamed'}</span>
                    <i class="bi bi-chevron-right"></i>
                </button>
            `);
        });
    }

    window.showUserHistory = (name) => {
        document.getElementById('member-list').style.display = 'none';
        document.getElementById('member-detail').style.display = 'block';
        document.getElementById('detail-name').innerText = name;
        const history = allLogs.filter(l => l.name === name).reverse();
        document.getElementById('detail-table-body').innerHTML = history.map(h => `
            <tr><td>${h.date}</td><td>${h.timestamp}</td><td>${h.type}</td><td>${h.status}</td></tr>
        `).join('');
    };

    window.toggleMemberView = (show) => {
        document.getElementById('member-list').style.display = show ? 'none' : 'block';
        document.getElementById('member-detail').style.display = show ? 'block' : 'none';
    };

</script>
</body>
</html>
