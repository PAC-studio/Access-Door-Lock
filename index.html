<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Smart Access Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #212529;
            --border-color: #dee2e6;
        }

        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --border-color: #333333;
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--text-main);
            font-family: 'Kanit', sans-serif; 
            transition: background 0.3s, color 0.3s;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏´‡∏ô‡πâ‡∏≤ Login */
        #login-section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ‡∏ã‡πà‡∏≠‡∏ô Dashboard ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô Login */
        #main-dashboard { display: none; }

        .card { 
            background-color: var(--card-bg);
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            color: var(--text-main);
        }

        .stat-card { background: linear-gradient(45deg, #0d6efd, #003d99); color: white; }
        .table-container { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-top: 20px; }
        
        .dark-mode .badge.bg-light {
            background-color: #2d2d2d !important;
            color: #ffffff !important;
            border: 1px solid #444 !important;
        }

        .dark-mode .table { color: #ffffff !important; }
        .dark-mode .table td, .dark-mode .table th { border-color: #333 !important; color: #ffffff !important; }

        #dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 50px;
        }

        .badge-in { background-color: #198754; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; }
        .badge-out { background-color: #dc3545; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; }
        
        .current-names-list {
            max-height: 180px;
            overflow-y: auto;
            margin-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 12px;
        }
        .name-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            margin-bottom: 8px;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>

<div id="login-section">
    <div class="card p-4" style="width: 380px;">
        <div class="text-center mb-4">
            <i class="bi bi-shield-lock-fill text-primary" style="font-size: 3rem;"></i>
            <h3 class="fw-bold mt-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
        </div>
        <div class="mb-3">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</label>
            <input type="text" id="username" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
        </div>
        <div class="mb-4">
            <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            <input type="password" id="password" class="form-control" placeholder="******">
        </div>
        <button id="login-btn" class="btn btn-primary w-100 py-2 fw-bold">Login</button>
        <p id="error-msg" class="text-danger mt-3 text-center small"></p>
    </div>
</div>

<div id="main-dashboard">
    <button id="dark-mode-toggle" class="btn btn-light shadow-sm">
        <i id="mode-icon" class="bi bi-moon-fill"></i> <span id="mode-text">‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</span>
    </button>

    <div class="container py-4">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="display-6 fw-bold text-primary mb-0">IoT Smart Access</h1>
                <p class="opacity-75 mb-0">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì <span id="admin-name" class="fw-bold text-dark">Admin</span></p>
            </div>
            <button id="logout-btn" class="btn btn-outline-danger rounded-pill px-4">
                <i class="bi bi-box-arrow-right me-2"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </header>

        <div class="row g-4 mb-4">
            <div class="col-md-12">
                <div class="card p-4 shadow-sm border-start border-primary border-5">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold mb-1">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏Ñ‡πâ‡∏≤‡∏á (Stay Open Mode)</h5>
                            <p class="text-secondary mb-0" id="stay-open-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</p>
                        </div>
                        <div class="form-check form-switch fs-3">
                            <input class="form-check-input" type="checkbox" id="stay-open-toggle">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card p-4 h-100">
                    <h6 class="opacity-75 fw-bold mb-3">‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h2 id="last-user" class="fw-bold m-0">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2>
                        <span id="status-display"></span> 
                    </div>
                    <div class="d-flex gap-2">
                        <span id="last-date" class="badge bg-light text-dark border"><i class="bi bi-calendar3 me-1"></i> -</span>
                        <span id="last-time" class="badge bg-light text-dark border"><i class="bi bi-clock me-1"></i> -</span>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-4 h-100 stat-card text-center border-0 shadow">
                    <h6 class="fw-bold opacity-75">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h6>
                    <div class="d-flex align-items-center justify-content-center">
                        <span id="people-count" class="display-3 fw-bold">0</span>
                        <span class="ms-3 fs-4">‡∏Ñ‡∏ô</span>
                    </div>
                    <div id="names-container" class="current-names-list">
                        <div class="text-white-50 small mb-2 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</div>
                        <div id="names-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container shadow-sm border">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold m-0"><i class="bi bi-clock-history me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h5>
                <button id="clear-btn" class="btn btn-outline-danger btn-sm rounded-pill">
                    <i class="bi bi-trash3-fill me-1"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr class="table-light">
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onChildAdded, remove, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCZ0MK0LRsZLpzAclPxflIa7eWAXAdRchM",
        authDomain: "smart-access-door-lock.firebaseapp.com",
        databaseURL: "https://smart-access-door-lock-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "smart-access-door-lock",
        storageBucket: "smart-access-door-lock.firebasestorage.app",
        messagingSenderId: "293000409354",
        appId: "1:293000409354:web:d626b13230990baff9caf3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- üîê ‡∏£‡∏∞‡∏ö‡∏ö Authentication (Login ‡∏î‡πâ‡∏ß‡∏¢ Username) ---
    const loginSection = document.getElementById('login-section');
    const mainDashboard = document.getElementById('main-dashboard');
    const loginBtn = document.getElementById('login-btn');
    const errorMsg = document.getElementById('error-msg');

    loginBtn.addEventListener('click', () => {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        const fakeEmail = user + "@insight.com"; // ‡∏´‡∏•‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏™‡∏°‡∏°‡∏ï‡∏¥

        signInWithEmailAndPassword(auth, fakeEmail, pass).catch(err => {
            errorMsg.innerText = "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
        });
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            loginSection.style.display = 'none';
            mainDashboard.style.display = 'block';
            document.getElementById('admin-name').innerText = user.email.split('@')[0];
            initDashboard();
        } else {
            loginSection.style.display = 'flex';
            mainDashboard.style.display = 'none';
        }
    });

    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    // --- üö™ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Dashboard ---
    function initDashboard() {
        const logRef = ref(db, 'access_logs');
        const stayOpenRef = ref(db, 'door_status/stay_open');
        let peopleInRoom = []; 

        // 1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á
        const toggleSwitch = document.getElementById('stay-open-toggle');
        const statusText = document.getElementById('stay-open-status');

        onValue(stayOpenRef, (snap) => {
            const isStayOpen = snap.val() || false;
            toggleSwitch.checked = isStayOpen;
            statusText.innerText = isStayOpen ? "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ (Stay Open ON)" : "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥ (Normal)";
            statusText.className = isStayOpen ? "fw-bold text-danger mb-0" : "text-secondary mb-0";
        });

        toggleSwitch.addEventListener('change', () => {
            set(stayOpenRef, toggleSwitch.checked);
        });

        // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Logs
        const tableBody = document.getElementById('table-body');
        tableBody.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà

        onChildAdded(logRef, (snapshot) => {
            const data = snapshot.val();
            updateUI(data);
        });

        function updateUI(data) {
            const lastUser = document.getElementById('last-user');
            const lastStatus = document.getElementById('status-display');
            const lastDate = document.getElementById('last-date');
            const lastTime = document.getElementById('last-time');
            const peopleCount = document.getElementById('people-count');
            const namesList = document.getElementById('names-list');
            const namesContainer = document.getElementById('names-container');

            const name = data.name || "Unknown";
            const date = data.date || "-";
            const time = data.timestamp || "--:--";
            const type = data.type || "RFID";
            const status = data.status || "In"; 

            if (status === "In") {
                if (!peopleInRoom.includes(name)) peopleInRoom.push(name);
            } else {
                peopleInRoom = peopleInRoom.filter(p => p !== name);
            }

            peopleCount.innerText = peopleInRoom.length;
            if (peopleInRoom.length > 0) {
                namesList.innerHTML = peopleInRoom.map(p => `
                    <div class="name-item">
                        <span><i class="bi bi-person-circle me-2"></i>${p}</span>
                        <span class="badge rounded-pill bg-white text-primary px-2" style="font-size: 0.65rem;">‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</span>
                    </div>
                `).join('');
                namesContainer.querySelector('.text-white-50').style.display = 'none';
            } else {
                namesList.innerHTML = "";
                namesContainer.querySelector('.text-white-50').style.display = 'block';
            }

            lastUser.innerText = name;
            lastDate.innerHTML = `<i class="bi bi-calendar3 me-1"></i> ${date}`;
            lastTime.innerHTML = `<i class="bi bi-clock me-1"></i> ${time}`;
            lastStatus.innerText = status === "In" ? "‡πÄ‡∏Ç‡πâ‡∏≤ (In)" : "‡∏≠‡∏≠‡∏Å (Out)";
            lastStatus.className = status === "In" ? "badge bg-success p-2 px-3 rounded-pill" : "badge bg-danger p-2 px-3 rounded-pill";

            const row = `<tr>
                <td>${date}</td>
                <td>${time}</td>
                <td class="fw-bold">${name}</td>
                <td><span class="badge bg-light text-secondary border">${type}</span></td>
                <td><span class="${status === 'In' ? 'badge-in' : 'badge-out'}">${status === 'In' ? '‡πÄ‡∏Ç‡πâ‡∏≤ (In)' : '‡∏≠‡∏≠‡∏Å (Out)'}</span></td>
            </tr>`;
            tableBody.insertAdjacentHTML('afterbegin', row);
        }
    }

    // --- üåó Dark Mode Logic ---
    const toggleBtn = document.getElementById('dark-mode-toggle');
    const modeIcon = document.getElementById('mode-icon');
    const modeText = document.getElementById('mode-text');

    function enableDarkMode() {
        document.body.classList.add('dark-mode');
        modeIcon.classList.replace('bi-moon-fill', 'bi-sun-fill');
        modeText.innerText = "‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á";
        localStorage.setItem('theme', 'dark');
    }

    function disableDarkMode() {
        document.body.classList.remove('dark-mode');
        modeIcon.classList.replace('bi-sun-fill', 'bi-moon-fill');
        modeText.innerText = "‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î";
        localStorage.setItem('theme', 'light');
    }

    toggleBtn.addEventListener('click', () => {
        document.body.classList.contains('dark-mode') ? disableDarkMode() : enableDarkMode();
    });
    if (localStorage.getItem('theme') === 'dark') enableDarkMode();

    document.getElementById('clear-btn').addEventListener('click', () => {
        if (confirm("‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            const logRef = ref(db, 'access_logs');
            remove(logRef).then(() => location.reload());
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>