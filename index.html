<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Access Control Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .status-online { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row mb-4">
        <div class="col text-center">
            <h1 class="display-5 fw-bold">ระบบบันทึกการเข้าห้อง IoT</h1>
            <p class="text-muted">ข้อมูลอัปเดตแบบ Real-time จาก Firebase</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4 mx-auto">
            <div class="card text-center p-4">
                <h5>สถานะล่าสุด</h5>
                <h3 id="last-user">รอการแสกน...</h3>
                <p id="last-time" class="text-muted small">-</p>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card p-4">
                <h4 class="mb-4">ประวัติการเข้าห้อง</h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>เวลา</th>
                                <th>ชื่อผู้ใช้งาน</th>
                                <th>ประเภท (RFID/Finger)</th>
                                <th>สถานะ</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // --- นำค่าจาก Firebase Config มาวางตรงนี้ ---
  const firebaseConfig = {
    authDomain: "smart-access-door-lock.firebaseapp.com",
    databaseURL: "https://smart-access-door-lock-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "smart-access-door-lock",
    storageBucket: "smart-access-door-lock.firebasestorage.app",
    messagingSenderId: "293000409354",
    appId: "1:293000409354:web:d626b13230990baff9caf3",
    measurementId: "G-RC2RW9054W"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const logRef = ref(db, 'access_logs');

  // ฟังเหตุการณ์เมื่อมีการเพิ่มข้อมูลใหม่ (Real-time)
  onChildAdded(logRef, (data) => {
    const val = data.val();
    updateUI(val);
  });

  function updateUI(data) {
    const tableBody = document.getElementById('table-body');
    const lastUser = document.getElementById('last-user');
    const lastTime = document.getElementById('last-time');

    // ตรวจสอบว่ามีข้อมูลส่งมาจริงไหม และดึงค่าออกมา
    // ถ้าใน Firebase พิมพ์ตัวเล็กตัวใหญ่ไม่ตรงกัน ให้แก้ในเครื่องหมาย ' ' ตรงนี้ครับ
    const name = data.name || data.Name || "Unknown";
    const time = data.timestamp || data.Time || "No Time";
    const type = data.type || data.Type || "N/A";

    // อัปเดตการ์ดด้านบน
    lastUser.innerText = name;
    lastTime.innerText = time;

    // เพิ่มแถวในตาราง
    const row = `<tr>
        <td>${time}</td>
        <td><strong>${name}</strong></td>
        <td><span class="badge bg-info text-dark">${type}</span></td>
        <td><span class="badge bg-success">Success</span></td>
    </tr>`;
    
    tableBody.insertAdjacentHTML('afterbegin', row);
  }
</script>
</body>
</html>